- トランザクション
  - 複数の更新をひとつにまとめて実行するための機能
  - 通常、トランザクションを採用せずにSQLを実行すると
    以下のようにSQLが実行された時点で更新が確定します。
    - ![sql](https://techpit-market-prod.s3.amazonaws.com/uploads/part_attachment/file/25283/d246c284-46fb-42b8-86ec-3369079a716e.png) abouttransactionforsql
  - トランザクションを導入すると、複数のSQLが全て実行された後に
    その更新を確定させることが可能となります。
    - ![sql](https://techpit-market-prod.s3.amazonaws.com/uploads/part_attachment/file/25284/f0519ff9-ef95-4b76-874c-a39174cf4724.png) testetstttttttttt

  - メリット
    - 障害が発生してバッチ処理が停止した際に
      トランザクションを導入していないと途中で更新停止
        - 導入していれば、それまでの更新は全て取り消しにできる
        - ランキング情報はバッチを実行する前の状態が維持
          テーブルのデータが不完全な状態で存在させてしまう事態に比べれば被害を最小限に抑えることが可能
  - デメリット
    - タイムアウトやデッドロックが発生する可能性
      - タイムアウト　
        トランザクションの仕組み上、先に開始したトランザクションが終了するまで同じデータを更新しようとしている他のトランザクションは待たされる
        そしてある一定の時間が経過した段階でデータベースが時間切れと判定し、他のトランザクションは停止
        - MySQLでは`innodb_lock_wait_timeout`でトランザクションの待ち時間が設定
        - `show global variables like 'innodb_lock_wait_timeout';`で確認
    - デッドロックは二つのトランザクションがお互いの終了を待ち続けることで、トランザクションが進行しなくなった状態
      - ![デッドロック](https://techpit-market-prod.s3.amazonaws.com/uploads/part_attachment/file/25290/8495167b-8e83-4b5e-9ec3-9af5e40fc92d.png) dedorokkugagagagagga
      - MySQLではデッドロックが発生すると片方のトランザクションが取り消し
    - タイムアウトとデッドロックの発生を防ぐには？
      - 他の更新処理と競合しない時間帯を見つけ、バッチ処理の実行スケジュールを正しく設定する必要
        - 確認項目
          1.バッチ処理が更新するテーブル
          2.同じ時間帯に実行される他の更新処理
          3.他の更新処理で更新しているテーブル
          - バッチ処理を更新するテーブル
          特に既存のバッチ処理を途中で引き継いだようなときは、入念に確認
            ソースコードから確認したり、`log/development.log`のような実行ログからも確認することが可能
          - 同じ時間帯に実行される他の更新処理
            バッチ処理本来の要件から望ましい時間帯が定まっているときはその時間帯を基準にしてスケジュール
              - 実行時間について細かい指定がないときは、他のバッチ処理が動作していない時間帯にスケジュールを設定
              - 競合の問題を避けるための最もよい方法はバッチ処理をひとつずつ実行すること
              - バッチサーバーのCPUやメモリなど消費リソースの面からも安定したバッチ処理の運行を維持しやすく
          - 他の更新処理で更新しているテーブル
            同じ時間帯に他の更新処理が実行される予定があるときは、更新するテーブルに同じものが含まれていないかを確認 もし含まれているときはスケジュールを変えて競合しないように調整

            - 更新処理はバッチ処理だけではないことにも注意してください。
              Webブラウザやスマホアプリなどクライアント向けのプログラムから更新が入る可能性も考えられ

            - 同じテーブルを更新する予定があり、どうしても同時実行が避けられないときはタイムアウトやデッドロックが発生する可能性がないかを検証します。
              - タイムアウトはタイムアウトの判定が出るまでにトランザクションが完了すれば発生はしません。
                - MySQLのデフォルトであれば50秒以内に完了すればよい 
                  ただし、競合している更新処理がユーザー向けである場合は注意が必要
                  - バッチ処理としてはそれで問題が解消されたように見えますが、
                  ユーザーの視点からすると待ち時間が発生しユーザー体験が著しく低下
              - デッドロックは更新範囲が被らないことが確認できれば発生を回避することが可能
              競合するバッチ処理それぞれが更新するデータの範囲が重ならないことを確認

  - MYSQL8.0だとトランザクションで`BEGIN;`使えるかも
    - `ROLLBACK;`は`COMMIT;`と同じで終了する際に使用する
    ロールバック前から`BEGIN;`までの処理を消してくれる

